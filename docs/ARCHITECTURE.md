# ACE Orchestrator 架构文档

## 1. 项目愿景

**ACE (AI Collaboration Engine)** 是一个自动化编排系统，通过模拟人类团队协作模式，让 AI 以"三角色分工"的方式自主完成软件开发任务。

### 核心理念

> "好的软件需要审查、规划、执行三个环节，任何一个角色独揽全部职责都会导致质量下降。"

传统的 AI 编程助手是单一角色：用户给需求，AI 直接写代码。这种模式存在问题：
- **没有审查**：代码质量依赖单次生成
- **没有规划**：复杂任务容易迷失方向
- **没有迭代**：错误难以被发现和修正

ACE 的解决方案是引入**角色分离**和**迭代循环**。

---

## 2. 三角色模型

```
┌─────────────────────────────────────────────────────────────┐
│                        AUDITOR (审计员)                      │
│  - 全局视野：负责项目规划和质量把控                            │
│  - 职责：拆解目标、分配任务、审查结果、决定下一步              │
│  - 人格：Linus Torvalds（严格、务实、关注架构）               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      COMMANDER (指挥官)                      │
│  - 战术层面：将抽象任务转化为具体执行方案                      │
│  - 职责：分析任务、设计方案、编写详细的执行指令                │
│  - 输出：AI_Task_Brief_[task_id].md                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       EXECUTOR (执行者)                      │
│  - 执行层面：严格按照指令完成代码编写                         │
│  - 职责：读取 Brief、编写代码、记录执行日志                   │
│  - 输出：Execution_Log_[task_id].md + 实际代码修改           │
└─────────────────────────────────────────────────────────────┘
```

### 为什么是三个角色？

| 角色 | 关注点 | 类比 |
|------|--------|------|
| Auditor | **做什么** (What) | 产品经理 + 架构师 |
| Commander | **怎么做** (How) | 技术 Leader |
| Executor | **去做** (Do) | 开发工程师 |

这种分离确保：
1. **关注点分离**：每个角色只需专注自己的职责
2. **信息隔离**：Executor 不直接接触原始需求，只看 Brief，避免误解
3. **质量保证**：Auditor 审查 Executor 的输出，形成闭环

---

## 3. 执行流程

### 3.1 整体流程图

```
                    ┌──────────────┐
                    │   用户启动    │
                    │  -i / -r     │
                    └──────┬───────┘
                           │
                           ▼
              ┌────────────────────────┐
              │     INIT PHASE         │
              │  Auditor 初始化项目     │
              │  - 创建 Roadmap        │
              │  - 设置第一个 task_id   │
              └────────────┬───────────┘
                           │
           ┌───────────────┴───────────────┐
           │         ITERATION LOOP        │
           │  ┌─────────────────────────┐  │
           │  │      COMMANDER          │  │
           │  │  生成 AI_Task_Brief     │  │
           │  └───────────┬─────────────┘  │
           │              │                │
           │              ▼                │
           │  ┌─────────────────────────┐  │
           │  │       EXECUTOR          │  │
           │  │  执行任务、写代码        │  │
           │  └───────────┬─────────────┘  │
           │              │                │
           │              ▼                │
           │  ┌─────────────────────────┐  │
           │  │    USER REVIEW (可选)   │  │
           │  │  用户反馈、修正方向      │  │
           │  └───────────┬─────────────┘  │
           │              │                │
           │              ▼                │
           │  ┌─────────────────────────┐  │
           │  │      GIT COMMIT         │  │
           │  │  保存本轮工作成果        │  │
           │  └───────────┬─────────────┘  │
           │              │                │
           │              ▼                │
           │  ┌─────────────────────────┐  │
           │  │       AUDITOR           │  │
           │  │  审查结果、决定下一步    │  │
           │  └───────────┬─────────────┘  │
           │              │                │
           │              ▼                │
           │    ┌─────────────────┐        │
           │    │ 检查 task_id    │        │
           │    └────────┬────────┘        │
           │             │                 │
           └─────────────┼─────────────────┘
                         │
          ┌──────────────┼──────────────┐
          │              │              │
          ▼              ▼              ▼
     ┌────────┐    ┌──────────┐   ┌──────────┐
     │ finish │    │  abort   │   │ task_xxx │
     │ 项目完成│    │ 项目终止 │   │ 继续迭代 │
     └────────┘    └──────────┘   └──────────┘
```

### 3.2 单次迭代详细流程

```
ITERATION N:
│
├─→ [1] COMMANDER
│       输入: current_task_id.txt
│       输出: AI_Task_Brief_[task_id].md
│       作用: 将任务转化为可执行的详细方案
│
├─→ [2] EXECUTOR
│       输入: AI_Task_Brief_[task_id].md
│       输出: Execution_Log_[task_id].md + 代码修改
│       作用: 按照 Brief 严格执行，不自作主张
│
├─→ [3] USER REVIEW (step mode)
│       输入: 用户观察执行结果
│       输出: user_feedback.txt (可选)
│       作用: 人类介入，修正方向或提供额外信息
│
├─→ [4] GIT COMMIT
│       作用: 将本轮所有修改提交到 git
│       消息: task_id + session_ids
│
└─→ [5] AUDITOR
        输入: Execution_Log + user_feedback (如有)
        输出: 更新 current_task_id.txt
        作用: 审查结果，决定下一个任务或终止
```

---

## 4. 上下文文件系统

所有状态都保存在 `context/` 目录下，实现**无状态编排**：

```
project/
└── context/
    ├── current_task_id.txt      # 当前任务 ID (核心状态)
    ├── System_State_Snapshot.md # 项目技术状态快照
    ├── Project_Roadmap.md       # 项目规划和进度
    ├── AI_Task_Brief_xxx.md     # Commander 输出的任务说明
    ├── Execution_Log_xxx.md     # Executor 输出的执行日志
    └── user_feedback.txt        # 用户反馈 (临时文件)
```

### 文件职责

| 文件 | 写入者 | 读取者 | 用途 |
|------|--------|--------|------|
| `current_task_id.txt` | Auditor | Orchestrator | 控制流程的核心状态 |
| `System_State_Snapshot.md` | Auditor | 所有角色 | 项目技术栈、架构、约束 |
| `Project_Roadmap.md` | Auditor | 所有角色 | 任务列表和进度追踪 |
| `AI_Task_Brief_xxx.md` | Commander | Executor | 任务的详细执行方案 |
| `Execution_Log_xxx.md` | Executor | Auditor | 执行结果和遇到的问题 |

### 停止信号

Auditor 通过 `current_task_id.txt` 控制流程：
- **task_xxx**: 继续执行指定任务
- **finish**: 项目成功完成，正常退出
- **abort**: 项目异常终止，需要人工介入

---

## 5. 设计原则

### 5.1 无状态编排

Orchestrator 本身不保存任何状态，所有状态都在 `context/` 目录中。这意味着：
- 可以随时中断和恢复 (`-r` 模式)
- 多个项目可以并行运行
- 状态可以被 git 追踪和回滚

### 5.2 人机协作 (Step Mode)

默认启用的 step mode 在每轮迭代后暂停，等待用户反馈：
- 用户可以观察 AI 的工作结果
- 提供修正建议或额外信息
- 防止 AI 在错误方向上持续浪费资源

### 5.3 Git 集成

每次迭代后自动 commit，提供：
- **可追溯性**: 每个 commit 记录了 session_id
- **可回滚性**: 出错时可以 git reset
- **透明性**: 所有修改都有记录

### 5.4 YOLO Mode

默认启用，让 codex 自动批准命令执行：
- 适合信任度高的任务
- 可用 `--no-yolo` 禁用，要求每个命令确认

---

## 6. 与 Codex 的关系

```
┌─────────────────────────────────────────────────────────────┐
│                      Orchestrator.py                        │
│  - 流程编排                                                  │
│  - 角色切换                                                  │
│  - Git 操作                                                  │
│  - 用户交互                                                  │
└──────────────────────────┬──────────────────────────────────┘
                           │ 调用
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                        codex.py                             │
│  - 封装 codex CLI                                           │
│  - 角色 prompt 注入                                          │
│  - 日志和错误处理                                            │
└──────────────────────────┬──────────────────────────────────┘
                           │ 调用
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                        codex CLI                            │
│  - OpenAI 官方工具                                          │
│  - 实际执行 AI 推理和代码操作                                │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. 典型使用场景

### 场景 1: 新项目启动

```bash
python Orchestrator.py -i -d ./myproject -R "构建一个带用户认证的 REST API"
```

1. Auditor 分析需求，创建 Roadmap，设置 task_001
2. Commander 为 task_001 生成详细 Brief
3. Executor 按 Brief 执行，创建项目结构
4. 用户 review，可以提供反馈
5. Git commit
6. Auditor 审查，设置 task_002
7. 循环...直到 Auditor 输出 `finish`

### 场景 2: 中断恢复

```bash
# 意外中断后
python Orchestrator.py -r -d ./myproject
```

从 `context/` 读取状态，继续上次的进度。

### 场景 3: 方向调整

```bash
python Orchestrator.py -r -d ./myproject -R "之前的目标作废，改为修复编译环境"
```

Auditor 会收到新指令，重新规划 Roadmap。

---

## 8. 扩展性考虑

当前架构支持以下扩展：

1. **新增角色**: 如 Tester、Reviewer
2. **并行执行**: 多个 Executor 并行处理不同任务
3. **不同 AI 后端**: 替换 codex 为其他 AI 工具
4. **Web UI**: 基于 context 文件构建可视化界面

---

## 9. 已知限制

1. **依赖 codex CLI**: 需要安装 OpenAI codex
2. **Windows 兼容性**: 需要处理路径和进程问题
3. **Token 消耗**: 每轮迭代都消耗 AI tokens
4. **单项目单实例**: 同一项目目录不能并行运行多个 Orchestrator

---

*文档版本: 2024-11-30*
*对应 Orchestrator.py 版本: step mode + YOLO mode default on*
